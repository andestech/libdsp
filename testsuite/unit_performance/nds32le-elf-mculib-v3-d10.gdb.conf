# virtual-header
#	/NOBACKUP/atcpcw04/kucj/source/AndeSight/sid/ins version 20150819
#	vepfile=/NOBACKUP/atcpcw04/kucj/source/AndeSight/vep/tmpl/ADP-XC5-for-D1088-SPU-32I.vep
#	target=sid
#	database /NOBACKUP/atcpcw04/kucj/source/AndeSight/sid/ins/vep2conf.db
#	mode=ide
#	syscall=os
#	endian=little
#	run=None
#	debug_mode=run
#	engine-type=scache
#	format=1

# virtual-load
load libaudio.la audio_component_library
load libcfc.la cfc_component_library
load libcgencpu.la cgen_component_library
load libconsoles.la console_component_library
load libdmac.la dmac_component_library
load libgdb.la gdb_component_library
load libglue.la glue_component_library
load libgpio.la gpio_component_library
load libi2c.la i2c_component_library
load libmapper.la mapper_component_library
load libmemory.la mem_component_library
load libndsethc.la NdsEthc_component_library
load libndslcdc.la NdsLcdc_component_library
load libpmu.la pmu_component_library
load libpwm.la pwm_component_library
load librtc.la rtc_component_library
load libsched.la sched_component_library
load libsdc.la sdc_component_library
load libtimers.la timer_component_library
load libuart.la uart_component_library

# virtual-new
new AD1881A_CODEC AC97CODEC
new hw-ahbc-atc020 AHB
new hw-cpu-nds32hf cpu
new hw-dmac-atc010 DMAC
new hw-ethc-atc010 ETHC
new hw-ftcfc010 CFC
new hw-ftpmu010 PMU
new hw-ftrtc010 RTC
new hw-ftsdc010 SDC
new hw-ftsspc010 SSPC
new hw-ftsspc010 SSPC2
new hw-ftwdt010 WDT
new hw-glue-sequence net-init
new hw-glue-sequence net-reset
new hw-glue-sequence net-yield
new hw-glue-sequence net-fini
new hw-glue-sequence net-flush
new hw-gpio-ftgpio010 GPIO
new hw-lcdc-atc010 LCDC
new hw-memory-ram/rom-basic Memory
new hw-memory-ram/rom-basic Memory2
new hw-memory-ram/rom-basic Memory3
new hw-memory-ram/rom-basic Memory9
new hw-memory-ram/rom-basic ILM-Memory
new hw-memory-ram/rom-basic DLM-Memory
new hw-nds-i2c I2C
new hw-nds-pwm PWM
new hw-timer-atc010 Timer
new hw-uart-atc010 Uart
new hw-uart-atc010 Uart3
new hw-uart-atc010 Uart2
new nds-sdmc SDRAMC
new nds-smc SMC
new sid-io-socket-gdbsrv cpu-gdb-socket
new sid-io-socket-vepio vepio
new sid-sched-host-accurate host-sched
new sid-sched-sim target-sched
new sw-debug-gdb cpu-gdb

# net-reset
set net-reset version-check "1.0.0.0"
set net-reset num-outputs "17"

connect-pin net-reset output-0 -> AC97CODEC rst
connect-pin net-reset output-1 -> CFC reset
connect-pin net-reset output-2 -> DMAC HRESET
connect-pin net-reset output-3 -> GPIO PRSTn
connect-pin net-reset output-4 -> LCDC reset!
connect-pin net-reset output-5 -> PMU prstn
connect-pin net-reset output-6 -> RTC PRESETn
connect-pin net-reset output-7 -> SDC PRSTn
connect-pin net-reset output-8 -> SSPC PRESETn
connect-pin net-reset output-9 -> SSPC2 PRESETn
connect-pin net-reset output-10 -> Timer PRESETn
connect-pin net-reset output-11 -> Uart Reset
connect-pin net-reset output-12 -> Uart2 Reset
connect-pin net-reset output-13 -> Uart3 Reset
connect-pin net-reset output-14 -> WDT PRESETn
connect-pin net-reset output-15 -> cpu reset!
connect-pin net-reset output-16 -> AHB reset

# net-init
set net-init version-check "1.0.0.0"
set net-init num-outputs "4"
connect-pin main starting -> net-init input

connect-pin net-init output-0 -> cpu-gdb-socket init
connect-pin net-init output-1 -> cpu-gdb init
connect-pin net-init output-2 -> net-reset input
connect-pin net-init output-3 -> vepio init

# net-fini
set net-fini version-check "1.0.0.0"
set net-fini num-outputs "3"
connect-pin main stopping -> net-fini input

connect-pin net-fini output-0 -> cpu-gdb-socket fini
connect-pin net-fini output-1 -> cpu-gdb deinit
connect-pin net-fini output-2 -> vepio fini

# net-yield
set net-yield version-check "1.0.0.0"
set net-yield num-outputs "2"

connect-pin net-yield output-0 -> cpu yield
connect-pin net-yield output-1 -> host-sched yield

# net-flush
set net-flush version-check "1.0.0.0"
set net-flush num-outputs "1"

connect-pin net-flush output-0 -> cpu flush-icache

# target-sched
set target-sched version-check "1.0.0.0"
set target-sched num-clients "9"
connect-pin main perform-activity -> target-sched advance

set target-sched 0-scale 2
connect-pin target-sched 0-event   -> Timer PCLK-clock-event
connect-pin target-sched 0-control <- Timer PCLK-clock-control

set target-sched 1-scale 2
connect-pin target-sched 1-event   -> Uart rx-timeout-event
connect-pin target-sched 1-control <- Uart rx-timeout-control

set target-sched 2-scale 2
connect-pin target-sched 2-event   -> Uart tx-timeout-event
connect-pin target-sched 2-control <- Uart tx-timeout-control

set target-sched 3-scale 2
connect-pin target-sched 3-event   -> Uart2 rx-timeout-event
connect-pin target-sched 3-control <- Uart2 rx-timeout-control

set target-sched 4-scale 2
connect-pin target-sched 4-event   -> Uart2 tx-timeout-event
connect-pin target-sched 4-control <- Uart2 tx-timeout-control

set target-sched 5-scale 2
connect-pin target-sched 5-event   -> Uart3 rx-timeout-event
connect-pin target-sched 5-control <- Uart3 rx-timeout-control

set target-sched 6-scale 2
connect-pin target-sched 6-event   -> Uart3 tx-timeout-event
connect-pin target-sched 6-control <- Uart3 tx-timeout-control

set target-sched 7-scale 2
connect-pin target-sched 7-event   -> WDT pclk-event
connect-pin target-sched 7-control <- WDT pclk-control

set target-sched 8-scale 1
connect-pin target-sched 8-event   -> cpu step!
connect-pin target-sched 8-control <- cpu step-cycles

# host-sched
set host-sched version-check "1.0.0.0"
set host-sched num-clients "6"
connect-pin main perform-activity -> host-sched advance

set host-sched 0-scale 100
connect-pin host-sched 0-event   -> ETHC aptc-rx-sche-event
connect-pin host-sched 0-control <- ETHC aptc-rx-sche-control

set host-sched 1-scale 100
connect-pin host-sched 1-event   -> ETHC aptc-tx-sche-event
connect-pin host-sched 1-control <- ETHC aptc-tx-sche-control

set host-sched 2-scale 100
connect-pin host-sched 2-event   -> LCDC refresh-sync-event
connect-pin host-sched 2-control <- LCDC refresh-sync-control

set host-sched 3-scale 1000
set host-sched 3-regular? 0
set host-sched 3-time 0
connect-pin host-sched 3-event   -> RTC extclk-event

set host-sched 4-scale 1
connect-pin host-sched 4-event   -> cpu-gdb-socket poll-event
connect-pin host-sched 4-control <- cpu-gdb-socket poll-control

set host-sched 5-scale 1
connect-pin host-sched 5-event   -> vepio poll-event
connect-pin host-sched 5-control <- vepio poll-control

# main
set main persistent? "1"

# vepio
set vepio version-check "1.0.0.0"
set vepio num-devices "11"
set vepio sockaddr-local "0.0.0.0:0"
set vepio verbose? "1"
set vepio max-poll-interval "1000"
set vepio poll-interval "500"
connect-pin vepio time-query -> target-sched time-query
connect-pin vepio time-high  <- target-sched time-high
connect-pin vepio time-low   <- target-sched time-low

set vepio device-name0 "CFC"
set vepio device-type0 "hw-ftcfc010"
  connect-pin vepio tx0 <- CFC "tx"
  connect-pin vepio rx0 -> CFC "rx"

set vepio device-name1 "Uart"
set vepio device-type1 "hw-uart-atc010"
  connect-pin vepio tx1 <- Uart "Sout"
  connect-pin vepio rx1 -> Uart "Sin"

set vepio device-name2 "Uart2"
set vepio device-type2 "hw-uart-atc010"
  connect-pin vepio tx2 <- Uart2 "Sout"
  connect-pin vepio rx2 -> Uart2 "Sin"

set vepio device-name3 "LCDC"
set vepio device-type3 "hw-lcdc-atc010"
  connect-pin vepio tx3 <- LCDC "lcd-out"
# connect-pin vepio rx3 -> LCDC ""

set vepio device-name4 "Uart3"
set vepio device-type4 "hw-uart-atc010"
  connect-pin vepio tx4 <- Uart3 "Sout"
  connect-pin vepio rx4 -> Uart3 "Sin"

set vepio device-name5 "SDC"
set vepio device-type5 "hw-sdc-ftsdc010"
  connect-pin vepio tx5 <- SDC "front-end-output"
  connect-pin vepio rx5 -> SDC "front-end-input"

set vepio device-name6 "RTC"
set vepio device-type6 "rtc"
  connect-pin vepio tx6 <- RTC "rtc_f"
# connect-pin vepio rx6 -> RTC ""

set vepio device-name7 "PWM"
set vepio device-type7 "pwm"
  connect-pin vepio tx7 <- PWM "fout"
# connect-pin vepio rx7 -> PWM ""

set vepio device-name8 "cpu"
set vepio device-type8 "cpu"
  connect-pin vepio tx8 <- cpu "profile-tx"
# connect-pin vepio rx8 -> cpu ""

set vepio device-name9 "AC97CODEC"
set vepio device-type9 "AC97CODEC"
  connect-pin vepio tx9 <- AC97CODEC "data_play"
  connect-pin vepio rx9 -> AC97CODEC "data_record"

set vepio device-name10 "GPIO"
set vepio device-type10 "gpio"
  connect-pin vepio tx10 <- GPIO "tx"
  connect-pin vepio rx10 -> GPIO "rx"

# cpu-gdb
set cpu-gdb version-check "1.0.0.0"
set cpu-gdb exit-on-detach? "1"

set cpu-gdb enable-Z-packet? true
set cpu-gdb operating-mode? false
set cpu-gdb exit-on-detach? "1"
#set cpu-gdb trace-gdbsid? 1
#set cpu-gdb trace-gdbserv? 1
relate cpu-gdb cpu cpu
relate cpu-gdb cfgroot main
relate cpu-gdb target-schedulers target-sched
relate cpu-gdb host-schedulers host-sched
connect-pin cpu-gdb trap <-> cpu trap
connect-pin cpu-gdb trap-code <- cpu trap-code

connect-pin cpu-gdb process-signal -> main stop!
connect-pin cpu-gdb yield -> net-yield input
connect-pin cpu-gdb flush-icache -> net-flush input
connect-pin cpu-gdb restart -> net-reset input

# cpu-gdb-socket
set cpu-gdb-socket version-check "1.0.0.0"
set cpu-gdb-socket verbose? "1"
set cpu-gdb-socket sockaddr-local "0.0.0.0:0"
set cpu-gdb-socket poll-interval "500"
set cpu-gdb-socket max-poll-interval "5000"

set cpu-gdb-socket alias "cpu-gdb-socket"
connect-pin cpu-gdb-socket rx -> cpu-gdb remote-rx
connect-pin cpu-gdb-socket tx <- cpu-gdb remote-tx

# AC97CODEC
set AC97CODEC version-check "1.0.0.0"
connect-pin SSPC2 ac97_resetn_r -> AC97CODEC RESET
connect-pin SSPC2 txd_r -> AC97CODEC SDATA_OUT

# AHB
connect-bus AHB region=0[0x90400000-0x904fffff] DMAC registers
connect-bus AHB region=1[0x90300000-0x903fffff] SDRAMC controller
connect-bus AHB region=2[0x90200000-0x902fffff] SMC controller
connect-bus AHB region=3[0x90600000-0x906fffff] LCDC registers
connect-bus AHB region=4[0x00000000-0x07ffffff] SDRAMC memory
connect-bus AHB region=5[0x90900000-0x909fffff] ETHC registers
connect-bus AHB region=6[0x80000000-0x87ffffff] Memory3 read-write-port
connect-bus AHB region=7[0x90100000-0x901fffff] Memory read-write-port
connect-bus AHB region=8[0x90500000-0x905fffff] Memory2 read-write-port

# APB
connect-bus AHB region=9[0x98200000-0x982fffff] Uart Bus
connect-bus AHB region=10[0x98500000-0x985fffff] WDT read-write-port
connect-bus AHB region=11[0x98600000-0x986fffff] RTC read-write-port
connect-bus AHB region=12[0x98400000-0x984fffff] Timer registers
connect-bus AHB region=13[0x98700000-0x987fffff] GPIO registers
connect-bus AHB region=14[0x98b00000-0x98bfffff] SSPC read-write-port
connect-bus AHB region=15[0x99400000-0x994fffff] SSPC2 read-write-port
connect-bus AHB region=16[0x98300000-0x983fffff] Uart2 Bus
connect-bus AHB region=17[0x99600000-0x996fffff] Uart3 Bus
connect-bus AHB region=18[0x90b00000-0x90bfffff] Memory9 read-write-port
connect-bus AHB region=19[0x98d00000-0x98dfffff] CFC registers
connect-bus AHB region=20[0x98e00000-0x98efffff] SDC read-write-port
connect-bus AHB region=21[0x99100000-0x991fffff] PWM registers
connect-bus AHB region=22[0x98a00000-0x98afffff] I2C registers
connect-bus AHB region=23[0x98100000-0x981fffff] PMU read-write-port

# CFC
set CFC version-check "1.0.0.0"

# cpu
set cpu version-check "1.0.0.1"
set cpu step-insn-count "10000"
set cpu engine-type "scache"
set cpu cpu-option "--config-cpu-type d1088 --config-2det 1 --config-bpnum 4  --config-drde 0 --config-dset 3 --config-dway 1 --config-dsz 3 --config-dlck 1 --config-dbank 2 --config-dbsav 1 --config-dlmb 0xe --config-dcen 0 --config-dmaen 0 --config-ep8min4 1 --config-epsz 0x8 --config-fatb 0 --config-fatbsz 0 --config-hptwk 1 --config-iset 3 --config-iway 1 --config-isz 3 --config-ilck 1 --config-ibank 1 --config-ibsav 1 --config-ilmb 0xe --config-icen 0 --config-isa-div on --config-isa-pex1 on --config-isa-pex2 on --config-isa-mac on --conf-isa-dsp 64-bit --config-acbf 1 --config-l2sup 1 --config-audioen 0 --config-isa-string on --config-lmdma 1 --config-mmu-ctl 0x4 --config-mmps 2 --config-mmpv 1 --config-ntpt 1 --config-ntme 1 --config-ntm0 PP0 --config-ntm1 PP1 --config-ntm2 PP2 --config-ntm3 PP3 --config-pfm 1 --config-tbw 3 --config-tbs 3 --config-tblck 1 --config-uitlb-size 4 --config-udtlb-size 8 --config-unea 1 --config-intlvl 3 --config-reduced-reg 0 --config-mul fast --config-amipf 0 --config-amipfsz 16B --config-next-precise 0  --nds32-profile-level 0 --pipeline-btb-size 0x0402 --pipeline-btb-on 1 --pipeline-dcache-miss-delay 82 --pipeline-dcache-off-delay 82 --pipeline-icache-off-delay 82 --pipeline-icache-miss-delay 82 --pipeline-on 1 --pipeline-rtp-on 1 --pipeline-sbp 1 --pipeline-iiq 1 --pipeline-gprport 3r2w --config-nod 0 --config-audio-bitmode mix --config-dma-timing-model 0 --config-core-to-external-bus-clk-ratio 1:1 --config-isa-fpu-sp on --config-fpu-reg 32SP16DP --config-fpuen 1 --config-core-to-fpu-clk-ratio 1:1 --config-isa-ifc on --config-isa-sat off --config-runtime-endian programmable --config-mcu-family 0 --config-shadow-sp 1 --config-ivbase 0 --config-dimbase 0 --config-bpv-type store --config-simpler-bpnum 0 --config-ivic-version v2 --config-ivic-only 32 --config-interrupt-priority-scheme program2FPL --config-bpmask full --config-addr24 0 --config-isa-eit on --config-adv-option 1 --conf-endian-device-reg on --init-endian-device-reg-en on --option-warning off --init-ntm-0-cache write-through --conf-zero-overhead-loop on --config-de 0 --environment operating --config-default-exception-support 0 --debug off --debug-basic off"

set cpu cpu-option "--conf-ilm on --conf-ilm-bank 1 --conf-ilm-size 512KB --conf-ilm-ex-connect on --conf-ilm-ex off --init-ilm-base 0x500000 --init-ilm-en on"
set cpu cpu-option "--conf-dlm on --conf-dlm-bank 1 --conf-dlm-size 512KB --conf-dlm-ex-connect on --conf-dlm-ex on --init-dlm-base 0x580000 --init-dlm-en on"
set cpu cpu-option "--ideal-zero-memory-latency on"



#fpu option
set cpu cpu-option "--config-isa-fpu-dp on --config-isa-fpu-sp on --config-fpu-reg 32SP16DP --config-fpuen 1 --config-fpu-fma 1"

set cpu endian "little"
relate cpu cfgroot main
relate cpu gdb cpu-gdb
connect-pin Uart2 INTR -> cpu hw11
connect-pin GPIO gpio_intr -> cpu hw13
connect-pin WDT wd_intr -> cpu hw16
connect-pin RTC rtc_alarm -> cpu hw17
connect-pin RTC rtc_sec -> cpu hw18
connect-pin Timer tmr_intr -> cpu hw19
connect-pin DMAC dmaint -> cpu hw21
connect-pin cpu software-int -> cpu hw9
connect-pin Uart3 INTR -> cpu hw7
connect-pin SDC sdc_intr -> cpu hw5
connect-pin SSPC2 ssp_intr -> cpu hw2
connect-pin I2C ISI2C -> cpu hw3
connect-pin cpu time-query -> target-sched time-query
connect-pin cpu time-high  <- target-sched time-high
connect-pin cpu time-low   <- target-sched time-low
connect-bus cpu data-memory AHB access-port
connect-bus cpu insn-memory AHB access-port
#connect-bus cpu ILM-bus AHB access-port
connect-bus cpu ILM-bus ILM-Memory read-write-port
#connect-bus cpu DLM-bus AHB access-port
connect-bus cpu DLM-bus DLM-Memory read-write-port

# DMAC
set DMAC version-check "1.0.0.0"
set DMAC endianess "2"
connect-bus DMAC AHBMaster0 AHB access-port

# ETHC
set ETHC version-check "1.0.0.0"
set ETHC bus-endian "2"
set ETHC host-endian "2"
connect-bus ETHC to-access-port AHB access-port

# GPIO
set GPIO version-check "1.0.0.0"

# I2C
set I2C version-check "1.0.0.0"

# LCDC
set LCDC version-check "1.0.0.0"
set LCDC bus-endian "2"
set LCDC absolute-sync "1"
connect-pin LCDC time-query -> target-sched time-query
connect-pin LCDC time-high  <- target-sched time-high
connect-pin LCDC time-low   <- target-sched time-low
connect-bus LCDC frame-buffer AHB access-port

# Memory
set Memory version-check "1.0.0.0"
set Memory size "0x00800000"

# Memory2
set Memory2 version-check "1.0.0.0"
set Memory2 size "0x00800000"

# Memory3
set Memory3 version-check "1.0.0.0"
set Memory3 size "0x08000000"

# Memory9
set Memory9 version-check "1.0.0.0"
set Memory9 size "0x00100000"

#ILM-Memory
set ILM-Memory version-check "1.0.0.0"
set ILM-Memory size "0x00080000"

#DLM-Memory
set DLM-Memory version-check "1.0.0.0"
set DLM-Memory size "0x00080000"


# PMU
set PMU version-check "1.0.0.0"

# PWM
set PWM version-check "1.0.0.0"

# RTC
set RTC version-check "1.0.0.0"

# SDC
set SDC version-check "1.0.0.0"
set SDC fifo-depth "4"

# SDRAMC
set SDRAMC version-check "1.0.0.0"
set SDRAMC size "0x08000000"

# SMC
set SMC version-check "1.0.0.0"
set SMC size "0x00100000"

# SSPC
set SSPC version-check "1.0.0.0"
set SSPC rx-fifo-depth "8"
set SSPC tx-fifo-depth "8"

# SSPC2
set SSPC2 version-check "1.0.0.0"
set SSPC2 rx-fifo-depth "8"
set SSPC2 tx-fifo-depth "8"
connect-pin AC97CODEC SDATA_IN -> SSPC2 rxd

# Timer
set Timer version-check "1.0.0.0"
set Timer ext2clk-div "1"
set Timer level-trigger? "0"

# Uart
set Uart version-check "1.0.0.0"

# Uart2
set Uart2 version-check "1.0.0.0"

# Uart3
set Uart3 version-check "1.0.0.0"

# WDT
set WDT version-check "1.0.0.0"
